# üéì Learning Platform - Documentation

## üìã T·ªïng quan h·ªá th·ªëng

N·ªÅn t·∫£ng h·ªçc t·∫≠p tr·ª±c tuy·∫øn v·ªõi c√°c t√≠nh nƒÉng:
- ‚úÖ Qu·∫£n l√Ω n·ªôi dung h·ªçc t·∫≠p (Lessons, Quizzes)
- ‚úÖ AI-powered auto-grading
- ‚úÖ Gamification (Points, Streaks, Leaderboard)
- ‚úÖ Multi-modal learning (Text, Video, Audio)
- ‚úÖ Spaced Repetition System
- ‚úÖ Real-time progress tracking

---

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Client Layer                          ‚îÇ
‚îÇ  Web (React) / Mobile (React Native) / Admin Dashboard  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   API Gateway                            ‚îÇ
‚îÇ  Authentication / Rate Limiting / Request Routing       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                Backend Services                          ‚îÇ
‚îÇ  ‚Ä¢ Auth Service                                          ‚îÇ
‚îÇ  ‚Ä¢ Content Service                                       ‚îÇ
‚îÇ  ‚Ä¢ Learning Service                                      ‚îÇ
‚îÇ  ‚Ä¢ Assessment Service                                    ‚îÇ
‚îÇ  ‚Ä¢ Gamification Service                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Database (PostgreSQL)                       ‚îÇ
‚îÇ  ‚Ä¢ User & Profile Management                            ‚îÇ
‚îÇ  ‚Ä¢ Content Management                                    ‚îÇ
‚îÇ  ‚Ä¢ Progress Tracking                                     ‚îÇ
‚îÇ  ‚Ä¢ Assessment & Scoring                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üë• H·ªá th·ªëng Roles & Permissions

### **1. Roles Definition**

```sql
-- B·∫£ng roles (c·∫ßn th√™m v√†o schema)
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- B·∫£ng user_roles (many-to-many)
CREATE TABLE user_roles (
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
    assigned_at TIMESTAMPTZ DEFAULT NOW(),
    assigned_by UUID REFERENCES users(id),
    PRIMARY KEY (user_id, role_id)
);

-- B·∫£ng permissions
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    resource VARCHAR(100) NOT NULL,  -- lessons, quizzes, users, etc.
    action VARCHAR(50) NOT NULL,     -- create, read, update, delete
    description TEXT,
    UNIQUE(resource, action)
);

-- B·∫£ng role_permissions
CREATE TABLE role_permissions (
    role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
    permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
    PRIMARY KEY (role_id, permission_id)
);
```

### **2. Roles Hierarchy**

| Role | Level | Description |
|------|-------|-------------|
| **SUPER_ADMIN** | 5 | To√†n quy·ªÅn h·ªá th·ªëng |
| **ADMIN** | 4 | Qu·∫£n l√Ω n·ªôi dung, users, reports |
| **TEACHER** | 3 | T·∫°o/s·ª≠a lessons, ch·∫•m b√†i, xem reports |
| **CONTENT_CREATOR** | 2 | T·∫°o lessons, media (kh√¥ng ch·∫•m b√†i) |
| **STUDENT** | 1 | H·ªçc b√†i, l√†m quiz, xem ti·∫øn ƒë·ªô |
| **GUEST** | 0 | Ch·ªâ xem preview (ch∆∞a login) |

### **3. Permission Matrix**

| Resource | SUPER_ADMIN | ADMIN | TEACHER | CONTENT_CREATOR | STUDENT |
|----------|-------------|-------|---------|-----------------|---------|
| **Users** |
| Create User | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| View Users | ‚úÖ | ‚úÖ | ‚úÖ (own students) | ‚ùå | ‚ùå |
| Edit User | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Delete User | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Assign Roles | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| **Lessons** |
| Create Lesson | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| View Lessons | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ (enrolled) |
| Edit Lesson | ‚úÖ | ‚úÖ | ‚úÖ (own) | ‚úÖ (own) | ‚ùå |
| Delete Lesson | ‚úÖ | ‚úÖ | ‚úÖ (own) | ‚ùå | ‚ùå |
| Publish Lesson | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Quizzes** |
| Create Quiz | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| View Quiz | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ (enrolled) |
| Edit Quiz | ‚úÖ | ‚úÖ | ‚úÖ (own) | ‚úÖ (own) | ‚ùå |
| View Answers | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Submissions** |
| Submit Answer | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| View Own Submissions | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| View All Submissions | ‚úÖ | ‚úÖ | ‚úÖ (own lessons) | ‚ùå | ‚ùå |
| Grade Submissions | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Reports** |
| View Analytics | ‚úÖ | ‚úÖ | ‚úÖ (own classes) | ‚ùå | ‚ùå |
| Export Data | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| View Leaderboard | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

---

## üîê Authentication Flow

### **1. Registration Flow**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ POST /api/auth/register
     ‚îÇ {email, password, display_name}
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Validate input
     ‚îÇ    - Email format
     ‚îÇ    - Password strength (min 8 chars, 1 uppercase, 1 number)
     ‚îÇ    - Check email exists
     ‚îÇ
     ‚îÇ 2. Hash password (bcrypt, rounds=12)
     ‚îÇ
     ‚îÇ 3. BEGIN TRANSACTION
     ‚îÇ    INSERT INTO users (email, password_hash, status='pending')
     ‚îÇ    INSERT INTO user_profiles (display_name, locale)
     ‚îÇ    INSERT INTO user_roles (role='STUDENT')
     ‚îÇ    INSERT INTO user_streaks (current_len=0)
     ‚îÇ    INSERT INTO user_points (lifetime=0)
     ‚îÇ    COMMIT
     ‚îÇ
     ‚îÇ 4. Generate verification token (JWT, 24h expiry)
     ‚îÇ    payload: {user_id, email, type: 'email_verification'}
     ‚îÇ
     ‚îÇ 5. Send verification email
     ‚îÇ    Link: https://app.com/verify?token=xxx
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Response       ‚îÇ
‚îÇ  {              ‚îÇ
‚îÇ    success: true‚îÇ
‚îÇ    message: ""  ‚îÇ
‚îÇ  }              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **2. Email Verification Flow**

```
User clicks verification link
     ‚îÇ
     ‚îÇ GET /api/auth/verify?token=xxx
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Verify JWT token
     ‚îÇ    - Check signature
     ‚îÇ    - Check expiry
     ‚îÇ    - Check type='email_verification'
     ‚îÇ
     ‚îÇ 2. UPDATE users
     ‚îÇ    SET email_verified = true,
     ‚îÇ        status = 'active',
     ‚îÇ        updated_at = NOW()
     ‚îÇ    WHERE id = token.user_id
     ‚îÇ
     ‚îÇ 3. Send welcome email
     ‚îÇ
     ‚ñº
Redirect to /login?verified=true
```

### **3. Login Flow (Standard)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ POST /api/auth/login
     ‚îÇ {email, password, remember_me}
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Query user by email
     ‚îÇ    SELECT * FROM users WHERE email = ?
     ‚îÇ
     ‚îÇ 2. Check user exists & status='active'
     ‚îÇ
     ‚îÇ 3. Verify password
     ‚îÇ    bcrypt.compare(password, user.password_hash)
     ‚îÇ
     ‚îÇ 4. Check email_verified = true
     ‚îÇ
     ‚îÇ 5. Get user roles
     ‚îÇ    SELECT r.name FROM roles r
     ‚îÇ    JOIN user_roles ur ON r.id = ur.role_id
     ‚îÇ    WHERE ur.user_id = ?
     ‚îÇ
     ‚îÇ 6. Get user profile
     ‚îÇ    SELECT * FROM user_profiles WHERE user_id = ?
     ‚îÇ
     ‚îÇ 7. Generate tokens
     ‚îÇ    ACCESS_TOKEN (JWT, 15min expiry)
     ‚îÇ    {
     ‚îÇ      user_id: uuid,
     ‚îÇ      email: string,
     ‚îÇ      roles: ['STUDENT'],
     ‚îÇ      type: 'access'
     ‚îÇ    }
     ‚îÇ
     ‚îÇ    REFRESH_TOKEN (JWT, 7 days or 30 days if remember_me)
     ‚îÇ    {
     ‚îÇ      user_id: uuid,
     ‚îÇ      type: 'refresh',
     ‚îÇ      jti: unique_id  // for revocation
     ‚îÇ    }
     ‚îÇ
     ‚îÇ 8. Store refresh token in DB
     ‚îÇ    INSERT INTO refresh_tokens
     ‚îÇ    (user_id, token_jti, expires_at, ip, user_agent)
     ‚îÇ
     ‚îÇ 9. Update last_login
     ‚îÇ    UPDATE users SET updated_at = NOW()
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Response       ‚îÇ
‚îÇ  {              ‚îÇ
‚îÇ    access_token ‚îÇ
‚îÇ    refresh_token‚îÇ
‚îÇ    user: {      ‚îÇ
‚îÇ      id,        ‚îÇ
‚îÇ      email,     ‚îÇ
‚îÇ      roles,     ‚îÇ
‚îÇ      profile    ‚îÇ
‚îÇ    }            ‚îÇ
‚îÇ  }              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚ñº
Client stores:
- access_token in memory (or sessionStorage)
- refresh_token in httpOnly cookie (secure, sameSite)
```

### **4. Token Refresh Flow**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ  Access token h·∫øt h·∫°n (401 Unauthorized)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ POST /api/auth/refresh
     ‚îÇ Cookie: refresh_token=xxx
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Verify refresh token
     ‚îÇ    - Check signature
     ‚îÇ    - Check expiry
     ‚îÇ    - Check type='refresh'
     ‚îÇ
     ‚îÇ 2. Check token in DB (not revoked)
     ‚îÇ    SELECT * FROM refresh_tokens
     ‚îÇ    WHERE token_jti = ? AND revoked_at IS NULL
     ‚îÇ
     ‚îÇ 3. Get user & roles (nh∆∞ login)
     ‚îÇ
     ‚îÇ 4. Generate NEW access token (15min)
     ‚îÇ
     ‚îÇ 5. (Optional) Rotate refresh token
     ‚îÇ    - Revoke old refresh token
     ‚îÇ    - Generate new refresh token
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Response       ‚îÇ
‚îÇ  {              ‚îÇ
‚îÇ    access_token ‚îÇ
‚îÇ    refresh_token‚îÇ  (if rotated)
‚îÇ  }              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **5. OAuth2 Login Flow (Google/Facebook)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ GET /api/auth/oauth/google
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ  Redirect to Google
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Google OAuth   ‚îÇ  User authorizes
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ Callback: /api/auth/oauth/google/callback?code=xxx
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Exchange code for tokens
     ‚îÇ    POST https://oauth2.googleapis.com/token
     ‚îÇ
     ‚îÇ 2. Get user info
     ‚îÇ    GET https://www.googleapis.com/oauth2/v2/userinfo
     ‚îÇ    {email, name, picture, email_verified}
     ‚îÇ
     ‚îÇ 3. Check if user exists
     ‚îÇ    SELECT * FROM users WHERE email = ?
     ‚îÇ
     ‚îÇ 4a. If exists:
     ‚îÇ     - Update profile (picture, name if changed)
     ‚îÇ     - Generate tokens (nh∆∞ login flow)
     ‚îÇ
     ‚îÇ 4b. If NOT exists:
     ‚îÇ     - CREATE user (email_verified=true, status='active')
     ‚îÇ     - CREATE profile (from OAuth data)
     ‚îÇ     - Assign STUDENT role
     ‚îÇ     - Generate tokens
     ‚îÇ
     ‚ñº
Redirect to frontend with tokens
```

### **6. Logout Flow**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ POST /api/auth/logout
     ‚îÇ Headers: Authorization: Bearer {access_token}
     ‚îÇ Cookie: refresh_token=xxx
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Verify access token (get user_id)
     ‚îÇ
     ‚îÇ 2. Revoke refresh token
     ‚îÇ    UPDATE refresh_tokens
     ‚îÇ    SET revoked_at = NOW()
     ‚îÇ    WHERE user_id = ? AND token_jti = ?
     ‚îÇ
     ‚îÇ 3. (Optional) Blacklist access token
     ‚îÇ    INSERT INTO token_blacklist (jti, expires_at)
     ‚îÇ    (only if access token has jti claim)
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Response       ‚îÇ
‚îÇ  {              ‚îÇ
‚îÇ    success: true‚îÇ
‚îÇ  }              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚ñº
Client clears:
- access_token from memory
- refresh_token cookie
```

### **7. Password Reset Flow**

```
Step 1: Request Reset
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
User forgets password
     ‚îÇ
     ‚îÇ POST /api/auth/forgot-password
     ‚îÇ {email}
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Check email exists
     ‚îÇ    (Always return success to prevent email enumeration)
     ‚îÇ
     ‚îÇ 2. Generate reset token (JWT, 1h expiry)
     ‚îÇ    payload: {user_id, email, type: 'password_reset'}
     ‚îÇ
     ‚îÇ 3. Store token hash in DB
     ‚îÇ    INSERT INTO password_reset_tokens
     ‚îÇ    (user_id, token_hash, expires_at)
     ‚îÇ
     ‚îÇ 4. Send reset email
     ‚îÇ    Link: https://app.com/reset-password?token=xxx
     ‚îÇ
     ‚ñº
Response: {success: true, message: "Check your email"}


Step 2: Reset Password
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
User clicks reset link
     ‚îÇ
     ‚îÇ POST /api/auth/reset-password
     ‚îÇ {token, new_password}
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth Service   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. Verify JWT token (signature, expiry, type)
     ‚îÇ
     ‚îÇ 2. Check token in DB (not used)
     ‚îÇ    SELECT * FROM password_reset_tokens
     ‚îÇ    WHERE token_hash = HASH(token)
     ‚îÇ      AND used_at IS NULL
     ‚îÇ      AND expires_at > NOW()
     ‚îÇ
     ‚îÇ 3. Validate new password
     ‚îÇ
     ‚îÇ 4. BEGIN TRANSACTION
     ‚îÇ    - Hash new password
     ‚îÇ    - UPDATE users SET password_hash = ?
     ‚îÇ    - UPDATE password_reset_tokens SET used_at = NOW()
     ‚îÇ    - Revoke ALL refresh tokens (force re-login)
     ‚îÇ    COMMIT
     ‚îÇ
     ‚îÇ 5. Send confirmation email
     ‚îÇ
     ‚ñº
Response: {success: true}
```

---

## üîí Security Best Practices

### **1. Password Security**
```javascript
// Hashing
const bcrypt = require('bcrypt');
const SALT_ROUNDS = 12;
const hash = await bcrypt.hash(password, SALT_ROUNDS);

// Password requirements
- Min 8 characters
- At least 1 uppercase letter
- At least 1 lowercase letter
- At least 1 number
- At least 1 special character (!@#$%^&*)
- Not in common password list (check against top 10k)
```

### **2. JWT Security**
```javascript
// Access Token (short-lived)
{
  "iss": "learning-platform",
  "sub": "user_id",
  "iat": 1234567890,
  "exp": 1234568790,  // 15 minutes
  "type": "access",
  "roles": ["STUDENT"]
}

// Refresh Token (long-lived)
{
  "iss": "learning-platform",
  "sub": "user_id",
  "iat": 1234567890,
  "exp": 1235172690,  // 7 days
  "type": "refresh",
  "jti": "unique-token-id"  // for revocation
}

// Secret keys (env variables)
ACCESS_TOKEN_SECRET=<strong-random-key-256bit>
REFRESH_TOKEN_SECRET=<different-strong-random-key>
```

### **3. Rate Limiting**
```javascript
// Login endpoint
- 5 attempts per 15 minutes per IP
- 10 attempts per hour per email
- Exponential backoff after failed attempts

// Registration endpoint
- 3 registrations per hour per IP
- Email verification required

// Password reset
- 3 requests per hour per email
- 10 requests per hour per IP
```

### **4. CSRF Protection**
```javascript
// Use SameSite cookies
Set-Cookie: refresh_token=xxx; 
  HttpOnly; 
  Secure; 
  SameSite=Strict; 
  Path=/api/auth/refresh

// CSRF tokens for state-changing operations
X-CSRF-Token: <token>
```

### **5. SQL Injection Prevention**
```javascript
// Always use parameterized queries
// ‚ùå BAD
const query = `SELECT * FROM users WHERE email = '${email}'`;

// ‚úÖ GOOD (SQLAlchemy ORM)
const user = await User.findOne({where: {email}});

// ‚úÖ GOOD (Raw query with params)
const user = await db.query(
  'SELECT * FROM users WHERE email = $1', 
  [email]
);
```

---

## üìä Database Schema for Auth

```sql
-- Refresh tokens table
CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    token_jti VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    revoked_at TIMESTAMPTZ,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_jti ON refresh_tokens(token_jti);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens(expires_at);

-- Password reset tokens
CREATE TABLE password_reset_tokens (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- OAuth providers
CREATE TABLE oauth_providers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    provider VARCHAR(50) NOT NULL,  -- google, facebook, github
    provider_user_id VARCHAR(255) NOT NULL,
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(provider, provider_user_id)
);

-- Audit log
CREATE TABLE auth_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    event_type VARCHAR(50) NOT NULL,  -- login, logout, register, etc.
    ip_address INET,
    user_agent TEXT,
    success BOOLEAN,
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_auth_logs_user_id ON auth_logs(user_id);
CREATE INDEX idx_auth_logs_created_at ON auth_logs(created_at);
```

---

## üöÄ API Endpoints Summary

### **Auth Endpoints**
```
POST   /api/auth/register              # ƒêƒÉng k√Ω
GET    /api/auth/verify                # X√°c th·ª±c email
POST   /api/auth/login                 # ƒêƒÉng nh·∫≠p
POST   /api/auth/refresh               # Refresh token
POST   /api/auth/logout                # ƒêƒÉng xu·∫•t
POST   /api/auth/forgot-password       # Qu√™n m·∫≠t kh·∫©u
POST   /api/auth/reset-password        # ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
GET    /api/auth/oauth/:provider       # OAuth login
GET    /api/auth/oauth/:provider/callback  # OAuth callback
```

### **User Management (Admin)**
```
GET    /api/admin/users                # List users (paginated)
GET    /api/admin/users/:id            # Get user detail
PUT    /api/admin/users/:id            # Update user
DELETE /api/admin/users/:id            # Delete user
POST   /api/admin/users/:id/roles      # Assign roles
DELETE /api/admin/users/:id/roles/:role_id  # Remove role
GET    /api/admin/users/:id/activity   # User activity log
```

### **Role Management (Super Admin)**
```
GET    /api/admin/roles                # List all roles
POST   /api/admin/roles                # Create role
PUT    /api/admin/roles/:id            # Update role
DELETE /api/admin/roles/:id            # Delete role
GET    /api/admin/permissions          # List all permissions
POST   /api/admin/roles/:id/permissions  # Assign permission
```

---

## üß™ Testing Authentication

```javascript
// Example test cases
describe('Authentication Flow', () => {
  test('Register new user', async () => {
    const res = await request(app)
      .post('/api/auth/register')
      .send({
        email: 'test@example.com',
        password: 'SecurePass123!',
        display_name: 'Test User'
      });
    
    expect(res.status).toBe(201);
    expect(res.body.success).toBe(true);
  });

  test('Login with valid credentials', async () => {
    const res = await request(app)
      .post('/api/auth/login')
      .send({
        email: 'test@example.com',
        password: 'SecurePass123!'
      });
    
    expect(res.status).toBe(200);
    expect(res.body.access_token).toBeDefined();
    expect(res.body.refresh_token).toBeDefined();
  });

  test('Access protected route with token', async () => {
    const token = 'valid_jwt_token';
    const res = await request(app)
      .get('/api/user/profile')
      .set('Authorization', `Bearer ${token}`);
    
    expect(res.status).toBe(200);
  });

  test('Reject invalid token', async () => {
    const res = await request(app)
      .get('/api/user/profile')
      .set('Authorization', 'Bearer invalid_token');
    
    expect(res.status).toBe(401);
  });
});
```

---

## üìù Environment Variables

```bash
# Server
NODE_ENV=production
PORT=3000
API_VERSION=v1

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/learning_db
DB_POOL_MIN=2
DB_POOL_MAX=10

# JWT
ACCESS_TOKEN_SECRET=your-256-bit-secret-key-here
ACCESS_TOKEN_EXPIRY=15m
REFRESH_TOKEN_SECRET=your-different-256-bit-secret
REFRESH_TOKEN_EXPIRY=7d
REFRESH_TOKEN_EXPIRY_REMEMBER=30d

# Email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=noreply@yourapp.com
SMTP_PASS=your-smtp-password
EMAIL_FROM=Learning Platform <noreply@yourapp.com>

# OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-secret
GOOGLE_CALLBACK_URL=https://api.yourapp.com/auth/oauth/google/callback

FACEBOOK_APP_ID=your-facebook-app-id
FACEBOOK_APP_SECRET=your-facebook-secret
FACEBOOK_CALLBACK_URL=https://api.yourapp.com/auth/oauth/facebook/callback

# Frontend URL
FRONTEND_URL=https://yourapp.com

# Rate Limiting
RATE_LIMIT_WINDOW=15m
RATE_LIMIT_MAX_REQUESTS=100

# Security
BCRYPT_ROUNDS=12
PASSWORD_MIN_LENGTH=8
```

---

## üìö Additional Resources

- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [OAuth 2.0 Specification](https://oauth.net/2/)
- [PostgreSQL Security](https://www.postgresql.org/docs/current/auth-methods.html)

---

## ü§ù Contributing

Xem [CONTRIBUTING.md](CONTRIBUTING.md) ƒë·ªÉ bi·∫øt chi ti·∫øt v·ªÅ quy tr√¨nh development.

## üìÑ License

MIT License - xem [LICENSE](LICENSE) file.